Subcommand: cook
================

Purpose: Run Record_Pipeline with a YAML config (recipe).
Kitchen (Record_Pipeline) + Chef (HumanFn/RecordFn) already exist.
You write the Recipe (config YAML).

This subcommand applies to any domain. Available HumanFns and RecordFns
are always discovered at runtime -- not listed here.

---

Config Format
=============

The config has two required top-level keys: `source_set_name` and `HumanRecords`
(inside `RecordArgs`).

```yaml
# Replace <Placeholders> with actual values.
# To find available HumanFns/RecordFns: ls code/haifn/fn_record/human/ and record/

source_set_name: "<CohortName>/@<SourceFnName>"     # REQUIRED: Input SourceSet

HumanRecords:                                        # REQUIRED: at top level of config
    <HumanFnName>:                                   #   or inside RecordArgs
        - <RecordFnName1>
        - <RecordFnName2>

record_set_version: 0                                # Default: 0
```

The config may also be nested under `RecordArgs`:

```yaml
source_set_name: "<CohortName>/@<SourceFnName>"

RecordArgs:
  HumanRecords:
    <HumanFnName>: ['<RecordFnName1>', '<RecordFnName2>']
  record_set_version: 0
  record_set_label: 1
  use_cache: false
  save_cache: true
```

**Required keys:** `source_set_name`, `HumanRecords`
**Optional keys:** `record_set_version` (default 0), `record_set_label`,
`use_cache`, `save_cache`

See `templates/config.yaml` for a fully annotated template.

---

How To Run
==========

**CLI command:**

```bash
source .venv/bin/activate
source env.sh
haistep-record --config <your_config>.yaml
```

**Test script:**

```bash
source .venv/bin/activate
source env.sh
python test/test_haistep/test_2_record/test_record.py \
    --config <your_config>.yaml
```

Find existing config examples:
```bash
ls config/   # look for test-haistep-* or record/ subdirectories
```

**Python API** (code/haipipe/record_base/record_pipeline.py):

```python
from haipipe.record_base import Record_Pipeline

# Example (illustrative -- use actual HumanFn and RecordFn names
# from ls code/haifn/fn_record/human/ and ls code/haifn/fn_record/record/)
config = {
    'HumanRecords': {'<HumanFnName>': ['<RecordFn1>', '<RecordFn2>']},
    'record_set_version': 0
}
pipeline = Record_Pipeline(config, SPACE)

record_set = pipeline.run(
    source_set,                          # SourceSet (required)
    partition_index=None,                # 0-based partition index
    partition_number=None,               # Total partitions
    record_set_label=1,                  # Label for ID generation
    use_cache=True,                      # Load cached if available
    save_cache=True,                     # Save to cache
    profile=False                        # Return timing if True
)
```

**WRONG (cohort_name does NOT exist as a parameter):**

```python
# DO NOT DO THIS:
record_set = pipeline.run(source_set, cohort_name='<anything>')
```

The RecordSet name is auto-generated by `_generate_record_set_name()` from
`source_set.source_set_name` and `config['record_set_version']`.

---

Available Chefs
================

Do not rely on a hardcoded list -- always discover what is registered:

```bash
# HumanFns available (entity wrapper creators)
ls code/haifn/fn_record/human/

# RecordFns available (record processors)
ls code/haifn/fn_record/record/
```

To see what SourceSet tables a RecordFn reads from, check its
RawName_to_RawConfig at the top of the generated file:
```bash
head -40 code/haifn/fn_record/record/<RecordFnName>.py
```

The HumanRecords mapping is fully domain-configurable. Any HumanFn can be
paired with any RecordFn that shares the same RawHumanID. The combination
and the list of RecordFns is defined in the config YAML, not hardcoded here.

If the RecordFn you need does not exist yet, use: /haipipe-data-2-record design-chef

**Note (illustrative example only):**
In the CGM domain, a typical HumanRecords config might look like:
```yaml
HumanRecords:
  HmPtt: ['Ptt', 'CGM5Min', 'Diet5Min', 'Exercise5Min', 'Med5Min', 'Weight5Min']
```
The exact names depend on what is registered in code/haifn/fn_record/record/.

---

Naming Convention
==================

**Output asset naming:** auto-generated as `<RawDataName>_v<N>RecSet`
  - The raw data name is extracted from source_set_name by stripping the @SourceFnName
  - Pattern: `"<CohortName>/@<SourceFnName>"` + version N -> `"<CohortName>_vNRecSet"`
  - Example (illustrative): `"OhioT1DM/@OhioT1DMxmlv250302"` + 0 -> `"OhioT1DM_v0RecSet"`

**Store path:** `_WorkSpace/2-RecStore/<RecordSetName>/`

---

Verification
============

After running, **verify** the output:

1. **Check** output directory exists:
   `ls _WorkSpace/2-RecStore/<RecordSetName>/`

2. **Verify** FLAT directory structure:
   `ls _WorkSpace/2-RecStore/<RecordSetName>/`
   Should show: `Human-<HumanFnName>/  Record-<HumanFnName>.<RecordFnName>/  ...`

3. **Check** manifest.json was created:
   `cat _WorkSpace/2-RecStore/<RecordSetName>/manifest.json`

4. **Load** and **inspect** (see 1-load.md for pattern):

   ```python
   from haipipe.record_base import RecordSet
   record_set = RecordSet.load_from_disk(
       path='_WorkSpace/2-RecStore/<RecordSetName>', SPACE=SPACE
   )
   record_set.info()
   ```

---

Prerequisites
=============

Before running Record_Pipeline:

1. **Activate** .venv: `source .venv/bin/activate`
2. **Load** env.sh: `source env.sh`
3. Input SourceSet must exist at `_WorkSpace/1-SourceStore/<source_set_name>/`
4. If SourceSet does not exist, **run** Source_Pipeline first
   (see haipipe-data-1-source cook)

---

MUST DO
=======

- **Use** only registered HumanFn and RecordFn names (see Available Chefs)
- **Ensure** source_set_name matches an existing SourceSet
- **Follow** config key format exactly
- **Activate** .venv and **load** env.sh before running

---

MUST NOT
========

- **NEVER invent** HumanFn/RecordFn names that do not exist in code/haifn/fn_record/
- **NEVER skip** required config keys (source_set_name, HumanRecords)
- **NEVER pass** `cohort_name` to `pipeline.run()` -- does not exist
- **NEVER create** files in code/haifn/ -- **use** design-chef if you need a new RecordFn
